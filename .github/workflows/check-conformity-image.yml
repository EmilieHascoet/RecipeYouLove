name: ðŸ”’ Check Conformity Image

on:
  workflow_call:
    inputs:
      image-tag:
        description: "Tag de l'image Docker Ã  scanner"
        required: true
        type: string

env:
  REGISTRY: ghcr.io

jobs:
  security-scan:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      packages: read
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” PrÃ©parer le nom de l'image
        id: image
        run: |
          # Convertir le nom du repository en minuscules (requis par Docker)
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_REF="${{ env.REGISTRY }}/${IMAGE_NAME}:${{ inputs.image-tag }}"
          
          echo "image-ref=${IMAGE_REF}" >> $GITHUB_OUTPUT
          echo "ðŸ” Image Ã  scanner: ${IMAGE_REF}"

      - name: ðŸ” VÃ©rifier que l'image existe
        run: |
          IMAGE_REF="${{ steps.image.outputs.image-ref }}"
          echo "ðŸ” VÃ©rification de l'image: $IMAGE_REF"
          
          if docker manifest inspect $IMAGE_REF > /dev/null 2>&1; then
            echo "âœ… Image trouvÃ©e dans le registry"
          else
            echo "âŒ Image non trouvÃ©e dans le registry!"
            echo "VÃ©rifiez que le job build-docker-image a rÃ©ussi."
            exit 1
          fi

      - name: ðŸ” Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ steps.image.outputs.image-ref }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: ðŸ” CrÃ©er fichier SARIF si manquant
        run: |
          if [ ! -f "trivy-results.sarif" ]; then
            echo "âš ï¸ Fichier SARIF non crÃ©Ã© par Trivy, crÃ©ation d'un rapport vide valide"
            cat > trivy-results.sarif <<'EOF'
          {
            "version": "2.1.0",
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "Trivy",
                    "informationUri": "https://github.com/aquasecurity/trivy",
                    "version": "0.0.0",
                    "rules": []
                  }
                },
                "results": []
              }
            ]
          }
          EOF
            echo "âœ… Fichier SARIF vide crÃ©Ã©"
          else
            echo "âœ… Fichier SARIF crÃ©Ã© avec succÃ¨s par Trivy"
            ls -lh trivy-results.sarif
          fi

      - name: ðŸ“¤ Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'
          category: trivy-scan

      - name: ðŸ” Run Trivy for detailed report
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ steps.image.outputs.image-ref }}
          format: 'table'
          output: 'trivy-report.txt'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: ðŸ“Š Parse Trivy results
        id: parse-trivy
        run: |
          REPORT_FILE="trivy-report.txt"
          
          if [ -f "$REPORT_FILE" ]; then
            # Compter les occurrences de maniÃ¨re robuste
            CRITICAL=0
            HIGH=0
            MEDIUM=0
            LOW=0
            
            if grep -q "CRITICAL" "$REPORT_FILE" 2>/dev/null; then
              CRITICAL=$(grep -c "CRITICAL" "$REPORT_FILE")
            fi
            
            if grep -q "HIGH" "$REPORT_FILE" 2>/dev/null; then
              HIGH=$(grep -c "HIGH" "$REPORT_FILE")
            fi
            
            if grep -q "MEDIUM" "$REPORT_FILE" 2>/dev/null; then
              MEDIUM=$(grep -c "MEDIUM" "$REPORT_FILE")
            fi
            
            if grep -q "LOW" "$REPORT_FILE" 2>/dev/null; then
              LOW=$(grep -c "LOW" "$REPORT_FILE")
            fi
          
            echo "critical=$CRITICAL" >> "$GITHUB_OUTPUT"
            echo "high=$HIGH" >> "$GITHUB_OUTPUT"
            echo "medium=$MEDIUM" >> "$GITHUB_OUTPUT"
            echo "low=$LOW" >> "$GITHUB_OUTPUT"
            
            echo "ðŸ“Š RÃ©sultats du scan de sÃ©curitÃ©:"
            echo "   ðŸ”´ CRITICAL: $CRITICAL"
            echo "   ðŸŸ  HIGH: $HIGH"
            echo "   ðŸŸ¡ MEDIUM: $MEDIUM"
            echo "   ðŸ”µ LOW: $LOW"
          else
            echo "âš ï¸ Rapport dÃ©taillÃ© non disponible"
            echo "critical=0" >> "$GITHUB_OUTPUT"
            echo "high=0" >> "$GITHUB_OUTPUT"
            echo "medium=0" >> "$GITHUB_OUTPUT"
            echo "low=0" >> "$GITHUB_OUTPUT"
          fi

      - name: ðŸ“¤ Upload Trivy report
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: trivy-report
          path: trivy-report.txt
          retention-days: 30

      - name: âš ï¸ Check security threshold
        run: |
          CRITICAL=${{ steps.parse-trivy.outputs.critical }}
          HIGH=${{ steps.parse-trivy.outputs.high }}
          
          echo "ðŸ“Š VÃ©rification des seuils de sÃ©curitÃ©..."
          echo "   CRITICAL: $CRITICAL (seuil: 0)"
          echo "   HIGH: $HIGH (seuil: 5)"
          
          if [ "$CRITICAL" -gt 0 ]; then
            echo "âŒ Ã‰CHEC: $CRITICAL vulnÃ©rabilitÃ©s CRITIQUES dÃ©tectÃ©es"
            echo "::error::Des vulnÃ©rabilitÃ©s critiques ont Ã©tÃ© dÃ©tectÃ©es. Corrigez-les avant de dÃ©ployer."
            exit 1
          fi
          
          if [ "$HIGH" -gt 5 ]; then
            echo "âš ï¸ ATTENTION: $HIGH vulnÃ©rabilitÃ©s HIGH dÃ©tectÃ©es (seuil: 5)"
            echo "::warning::Trop de vulnÃ©rabilitÃ©s HIGH. Recommandation: corriger avant dÃ©ploiement."
          fi
          
          echo "âœ… Scan de sÃ©curitÃ© passÃ© avec succÃ¨s"
          
          # CrÃ©er un rÃ©sumÃ© GitHub
          echo "### ðŸ”’ Scan de sÃ©curitÃ© terminÃ©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| SÃ©vÃ©ritÃ© | Nombre | Statut |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ CRITICAL | $CRITICAL | $([ "$CRITICAL" -eq 0 ] && echo "âœ… OK" || echo "âŒ Ã‰CHEC") |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  HIGH | $HIGH | $([ "$HIGH" -le 5 ] && echo "âœ… OK" || echo "âš ï¸ WARNING") |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ MEDIUM | ${{ steps.parse-trivy.outputs.medium }} | â„¹ï¸ Info |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”µ LOW | ${{ steps.parse-trivy.outputs.low }} | â„¹ï¸ Info |" >> $GITHUB_STEP_SUMMARY
