name: âœ… Check Coverage

on:
  workflow_call:
    inputs:
      java-version:
        description: "Version de Java Ã  utiliser"
        required: true
        type: string
      coverage-threshold:
        description: "Seuil minimum de couverture (%)"
        required: false
        type: string
        default: "60"

jobs:
  check-coverage:
    name: ðŸ“Š VÃ©rifier la couverture
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download JaCoCo Report
        uses: actions/download-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/

      - name: ðŸ“Š Analyser la couverture JaCoCo
        run: |
          # VÃ©rifier que le rapport JaCoCo existe
          if [ ! -f "target/site/jacoco/jacoco.xml" ]; then
            echo "âŒ Rapport JaCoCo non trouvÃ©!"
            echo "ðŸ“‚ Contenu de target/site/jacoco/:"
            ls -la target/site/jacoco/ || echo "Le dossier n'existe pas"
            exit 1
          fi
          
          echo "âœ… Rapport JaCoCo trouvÃ©"
          
          # Extraire les statistiques de couverture depuis jacoco.xml
          INSTRUCTIONS_MISSED=$(grep -oP 'type="INSTRUCTION".*?missed="\K[0-9]+' target/site/jacoco/jacoco.xml | head -1)
          INSTRUCTIONS_COVERED=$(grep -oP 'type="INSTRUCTION".*?covered="\K[0-9]+' target/site/jacoco/jacoco.xml | head -1)
          
          TOTAL=$((INSTRUCTIONS_MISSED + INSTRUCTIONS_COVERED))
          
          if [ "$TOTAL" -eq 0 ]; then
            COVERAGE=0
          else
            COVERAGE=$((INSTRUCTIONS_COVERED * 100 / TOTAL))
          fi
          
          THRESHOLD=${{ inputs.coverage-threshold }}
          
          echo "ðŸ“Š Couverture de code: ${COVERAGE}%"
          echo "   - Instructions couvertes: ${INSTRUCTIONS_COVERED}"
          echo "   - Instructions totales: ${TOTAL}"
          echo ""
          echo "ðŸŽ¯ Seuil requis: ${THRESHOLD}%"
          
          # CrÃ©er un rÃ©sumÃ© GitHub
          echo "### ðŸ“Š Rapport de couverture de code" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| MÃ©trique | Valeur |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ˆ Couverture | **${COVERAGE}%** |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ Seuil requis | ${THRESHOLD}% |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Instructions couvertes | ${INSTRUCTIONS_COVERED} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Instructions totales | ${TOTAL} |" >> $GITHUB_STEP_SUMMARY
          
          # VÃ©rifier le seuil
          if [ "$COVERAGE" -lt "$THRESHOLD" ]; then
            MISSING=$((THRESHOLD - COVERAGE))
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Ã‰CHEC**: La couverture de code (${COVERAGE}%) est infÃ©rieure au seuil requis de ${THRESHOLD}%" >> $GITHUB_STEP_SUMMARY
            echo "   Il manque ${MISSING}% de couverture pour atteindre l'objectif" >> $GITHUB_STEP_SUMMARY
            echo ""
            echo "âŒ Ã‰CHEC: La couverture de code (${COVERAGE}%) est infÃ©rieure au seuil requis de ${THRESHOLD}%"
            echo "   Il manque ${MISSING}% de couverture pour atteindre l'objectif"
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **SUCCÃˆS**: La couverture de code rÃ©pond aux exigences!" >> $GITHUB_STEP_SUMMARY
            echo ""
            echo "âœ… SUCCÃˆS: La couverture de code rÃ©pond aux exigences!"
          fi

      - name: ðŸ“¤ Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jacoco-report-verified
          path: target/site/jacoco/
          retention-days: 30
