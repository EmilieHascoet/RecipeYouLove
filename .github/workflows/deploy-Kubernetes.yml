name: ðŸš€ Deploy to Kubernetes

on:
  workflow_call:
    inputs:
      environment:
        description: "Environnement cible (dev/staging/production)"
        required: true
        type: string
      image-tag:
        description: "Tag de l'image Docker"
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: ðŸš€ Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: ðŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: ðŸ” Configure Kubernetes credentials
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBE_CONFIG" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          kubectl cluster-info

      - name: ðŸ“‹ DÃ©terminer le namespace et app name
        id: config
        run: |
          case "${{ inputs.environment }}" in
            production) NAMESPACE="prod" ;;
            staging) NAMESPACE="staging" ;;
            dev) NAMESPACE="dev" ;;
            *) NAMESPACE="dev" ;;
          esac
          
          # Extraire le nom depuis pom.xml
          APP_NAME=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout 2>/dev/null || echo "application")
          
          echo "namespace=${NAMESPACE}" >> $GITHUB_OUTPUT
          echo "app_name=${APP_NAME}" >> $GITHUB_OUTPUT
          
          echo "ðŸš€ DÃ©ploiement de: $APP_NAME"
          echo "ðŸ“¦ Namespace: $NAMESPACE"
          echo "ðŸ·ï¸ Image tag: ${{ inputs.image-tag }}"

      - name: ðŸ“¦ VÃ©rifier/CrÃ©er namespace
        run: |
          NAMESPACE="${{ steps.config.outputs.namespace }}"
          if ! kubectl get namespace $NAMESPACE &> /dev/null; then
            echo "ðŸ“¦ CrÃ©ation du namespace: $NAMESPACE"
            kubectl create namespace $NAMESPACE
          else
            echo "âœ… Namespace $NAMESPACE existe dÃ©jÃ "
          fi

      - name: ðŸ” Create Image Pull Secret
        run: |
          NAMESPACE="${{ steps.config.outputs.namespace }}"
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --namespace=$NAMESPACE \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: ðŸš€ Deploy with Helm
        working-directory: helm-charts
        run: |
          NAMESPACE="${{ steps.config.outputs.namespace }}"
          APP_NAME="${{ steps.config.outputs.app_name }}"
          IMAGE_TAG="${{ inputs.image-tag }}"
          
          VALUES_FILE="values-${{ inputs.environment }}.yaml"
          if [ ! -f "$VALUES_FILE" ]; then
            echo "âš ï¸ Fichier $VALUES_FILE non trouvÃ©, utilisation de values.yaml"
            VALUES_FILE="values.yaml"
          fi
          
          echo "ðŸ“‹ DÃ©ploiement avec les valeurs: $VALUES_FILE"
          
          helm upgrade --install $APP_NAME . \
            --namespace $NAMESPACE \
            --create-namespace \
            --values $VALUES_FILE \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=$IMAGE_TAG \
            --set nameOverride=$APP_NAME \
            --set fullnameOverride=$APP_NAME \
            --wait \
            --timeout 5m

      - name: ðŸ” VÃ©rifier le dÃ©ploiement
        run: |
          NAMESPACE="${{ steps.config.outputs.namespace }}"
          APP_NAME="${{ steps.config.outputs.app_name }}"
          
          echo "â³ Attente que les pods soient prÃªts..."
          kubectl wait --for=condition=ready pod -l app=$APP_NAME --namespace=$NAMESPACE --timeout=300s
          
          echo "âœ… Pods dÃ©ployÃ©s:"
          kubectl get pods -n $NAMESPACE -l app=$APP_NAME
          
          echo ""
          echo "ðŸ“Š Services:"
          kubectl get svc -n $NAMESPACE -l app=$APP_NAME

      - name: ðŸ’¾ Save deployment info
        run: |
          NAMESPACE="${{ steps.config.outputs.namespace }}"
          APP_NAME="${{ steps.config.outputs.app_name }}"
          
          # Sauvegarder les infos pour les tests d'intÃ©gration
          mkdir -p deployment-info
          
          SERVICE_NAME=$(kubectl get svc -n $NAMESPACE -l app=$APP_NAME -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          SERVICE_PORT=$(kubectl get svc -n $NAMESPACE -l app=$APP_NAME -o jsonpath='{.items[0].spec.ports[0].port}' 2>/dev/null || echo "8080")
          
          cat > deployment-info/app.json <<EOF
          {
            "application": "$APP_NAME",
            "namespace": "$NAMESPACE",
            "service_name": "$SERVICE_NAME",
            "service_port": "$SERVICE_PORT",
            "image_tag": "${{ inputs.image-tag }}",
            "environment": "${{ inputs.environment }}"
          }
          EOF
          
          echo "ðŸ“„ Informations de dÃ©ploiement sauvegardÃ©es"

      - name: ðŸ“¤ Upload deployment info
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info
          path: deployment-info/app.json
          retention-days: 1

      - name: ðŸ“Š Deployment Summary
        run: |
          NAMESPACE="${{ steps.config.outputs.namespace }}"
          APP_NAME="${{ steps.config.outputs.app_name }}"
          
          echo "### ðŸš€ DÃ©ploiement rÃ©ussi" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ParamÃ¨tre | Valeur |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Application | \`$APP_NAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Environnement | **${{ inputs.environment }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| â˜¸ï¸ Namespace | \`$NAMESPACE\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ·ï¸ Image Tag | \`${{ inputs.image-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Image | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.image-tag }}\` |" >> $GITHUB_STEP_SUMMARY
